<html>

<head>
    <meta charset="utf-8"/>
	<script type="text/javascript" src="javascripts/jquery-3.2.1.min.js"></script>
<script>
var xhr = null;                 
try{    
	xhr = new ActiveXObject("Msxml2.XMLHTTP");    
}catch(e){    
	try{    
		xhr = new ActiveXObject("Microsoft.XMLHTTP");    
	}catch(e){}    
}
  
if (!xhr) 
	xhr = new XMLHttpRequest();

var url_array = new Array();

function removeByValue(arr, val) {
  for(var i=0; i<arr.length; i++) {
    if(arr[i] == val) {
      arr.splice(i, 1);
      break;
    }
  }
}


function host(){
	return $("#text_host").val();
}

function port(){
	return $("#text_port").val();
}

function onDeviceReady() {
	var strKey = "url_array"; 
	var storage = window.localStorage; 
	var value = storage.getItem(strKey);
	
	console.log('value=', value, '$("#text_host")=', $("#text_host"));
	if(value==null)
		return;
		
	var strs= value.split(",");
	for(var i=0;i<strs.length ;i++ ){
		if(strs[i].length > 0){
			if(i == 0){
				var hosts = strs[i].split(":");
				$("#text_host").attr("value", hosts[0]);
				$("#text_port").attr("value", hosts[1]);
				//$("#text_host").text(hosts[0]);
				//$("#text_port").text(hosts[1]);
				console.log('hosts[0]=', hosts[0], 'hosts[1]=', hosts[1]);
				inserted = true;
			}
			url_array.push(strs[i]);
		}
	}
}

function save_url_array(url)
{
	var strKey = "url_array"; 
	console.log('url=', url);
	if(url_array[0] == url)
		return;
	
	removeByValue(url_array, url);
	url_array.unshift(url);
	var strValue = '';
	
	url_array.forEach(function (element, index, array) {  
		// element: 指向当前元素的值  
		// index: 指向当前索引  
		// array: 指向Array对象本身  
		if(strValue.length > 0){
			strValue = strValue + ',' + element;
		}else{
			strValue = element;
		} 
	});
	
	console.log('url=', url, 'strValue=', strValue);
	var storage = window.localStorage; 
	storage.setItem(strKey, strValue);
}

function request(url_fun, url_arg, url_type){
	var url_host = $("#text_host").val();
	var url_port = $("#text_port").val();
	var url_number = $("#block_number").val();
	if(url_host == undefined || url_host.length == 0)
		url_host = window.location.host;
	if(url_port == undefined || url_port.length == 0)
		url_port = '8545';
	
	console.log('url_host=', url_host, ",url_port=", url_port, ",url_number=", url_number);
	
	$.ajax({    
		url: '/web3/',    
		type: 'get',    
		dataType: 'json',   
		contentType: 'application/json',    
		data: {host:url_host,port:url_port,fun:url_fun,arg:url_arg,type:url_type},    
		success: function(objResult) {
			console.log("objResult=", objResult);
			$("#result").text(JSON.stringify(objResult, null, 4));
			
			if(objResult != null && objResult != {})
				save_url_array(url_host + ':' + url_port);
		}
	});

	console.log(',$("#blockNumber").val())=', $("#blockNumber").val(), ",window.location.host=", window.location.host, ",window.location.port=", window.location.port);
};

function on_submit(obj)
{
	console.log('$(obj)=', $(obj));

	console.log('obj.children=', obj.children);

	var arr = $(obj).children("input");
	var arg = '';
	var fun = $(obj)[0].name;
	var type = $(obj)[0].className;
	
	for(var i=0;i<arr.length;i++){
		if(arr[i].type == 'submit')
			continue;
		
		var value = arr[i].value;
		console.log('value=', value, 'arg=', arg, ',arr=', arr);
		if(value == null || 0 == value.length)
			value = '""';
			
		if(arg.length){
			arg = arg + '' + value;
		}else{
			arg = value;
		}

	}

	console.log('fun=', fun, 'arg=', arg, 'type=', type);
	

	console.log('$(obj).children("input")=', $(obj).children("input"));
	
	console.log('this=', this);

	request(fun, arg, type);
	//addForm.username.focus();
	return false;
	return true;
}
   
function getBlockByNumber(){
	/*
	var url = '/web3/getBlockByNumber()';
	
	$.get(url, function(objResult) {
		if (objResult.data != null) {   
			console.log("objResult.data=", objResult.data);         
		}
	});
		*/
	
	var url_host = $("#text_host").val();
	var url_port = $("#text_port").val();
	var url_number = $("#block_number").val();
	if(url_host == undefined || url_host.length == 0)
		url_host = window.location.host;
	if(url_port == undefined || url_port.length == 0)
		url_port = '8545';
	
	console.log('url_host=', url_host, ",url_port=", url_port, ",url_number=", url_number);
	
	$.ajax({    
		url: '/web3/',    
		type: 'get',    
		dataType: 'json',   
		contentType: 'application/json',    
		data: {host:url_host,port:url_port,number:url_number},    
		success: function(objResult) {
			console.log("objResult=", objResult);
			$("#result").text(JSON.stringify(objResult, null, 4));
			
			if(objResult != null && objResult != {})
				save_url_array(url_host + ':' + url_port);
		}
	});

	console.log(',$("#blockNumber").val())=', $("#blockNumber").val(), ",window.location.host=", window.location.host, ",window.location.port=", window.location.port);
/*
	xhr.onreadystatechange=function(){
		if (xhr.readyState==4 && xhr.status==200){
			console.log("xhr.responseText=", xhr.responseText);
			//document.getElementById("myDiv").innerHTML=xmlhttp.responseText;
		}
	}
	
	var url = "http://localhost:3000/web3/web3.getBlockByNumber(" + $("#blockNumber").val() + ")";
	console.log('url=', url, ',$("#blockNumber").val())=', $("#blockNumber").val());
	xhr.open("GET",encodeURI(url),true);
	xhr.send();
	*/
};

</script>

<style type="text/css">
	html
	{
	 height:100%;
	 margin:0;
	}
	body
	{
		height:100%;
		margin:0; 
	}
	
	.a{ width:38%; float:left;border:1px solid green;height:100%;}
	.b{ width:60%; margin-left:38%;border:1px solid orange;height:100%;}
</style>

</head>

<body>
<div align="center">
<p>
	<input type="text" id="text_host" value="192.168.1.1"> </input>
	<input type="number" id="text_port" min="1" max="65535" value="8545"> </input>
    <select>
        <option value="volvo">Volvo</option>
        <option value="saab">Saab</option>
        <option value="fiat">Fiat</option>
        <option value="audi">Audi</option>
    </select>
    
    <a href="/test">contract test</a>
</p>


<div class="w">
	<div class="a"><div align="left">

	<form action="/web3/" class="fun.sync" method="get" name="eth.getBlock"  onsubmit="return on_submit(this);">
		getBlockByNumber: <input type="text" name="fname" value="0" />
		<input type="submit" name="submit" value="Submit"/>
    </form>
    
    <form action="/web3/" class="" method="get" name="eth.blockNumber"  onsubmit="return on_submit(this);">
		blockNumber: <input type="text" name="fname" />
		<input type="submit" name="submit" value="Submit"/>
    </form>
 
    </div></div>
    <div class="b"><div align="left" id="result" style="word-wrap: break-word; white-space: pre-wrap; white-space: -moz-pre-wrap">
</div></div>
</div>


</div>

<script type="text/javascript">
$(document).ready(function(){
	onDeviceReady();
});

</script>
</body>

</html>