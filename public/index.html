<html>

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="Access-Control-Allow-Origin" content="192.168.153.128">
    <meta http-equiv="Access-Control-Allow-Methods" content="POST,GET">
	<script type="text/javascript" src="javascripts/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="javascripts/json_rpc.js"></script>
    <script type="text/javascript" src="javascripts/ethjs-abi.js"></script>
    <script type="text/javascript" src="javascripts/webs.js"></script>
<script>


var url_array = new Array();

function getRequest() {
    var xmlHttpRequest = null;
    if(window.XMLHttpRequest) {
        xmlHttpRequest = new XMLHttpRequest();
    } else {
        if(window.ActiveXObject) {
            try {//IE5、6
                xmlHttpRequest = new ActiveXObject("Microsoft.XMLHTTP");
            } catch(e) {
                try {
                    xmlHttpRequest = new ActiveXObject("Msxml2.XMLHTTP");
                } catch(e) {}
            }
        }
    }
    return xmlHttpRequest;
}

function removeByValue(arr, val) {
  for(var i=0; i<arr.length; i++) {
    if(arr[i] == val) {
      arr.splice(i, 1);
      break;
    }
  }
}

function set_url(url)
{
	var hosts = url.split(":");
	$("#text_host").attr("value", hosts[0]);
	$("#text_port").attr("value", hosts[1]);
	
	console.log("url=", url, "hosts[0]=", hosts[0], "hosts[1]=", hosts[1]);
}

function set_select()
{
	$("#url_list").empty();
	var select = document.getElementById("url_list"); 
	url_array.forEach(function (element, index, array) {  
		// element: 指向当前元素的值  
		// index: 指向当前索引  
		// array: 指向Array对象本身  
		select.add(new Option(element,"")); 
	});
}

function url_key(){
	return "url_array." + window.location.href;
}

function host() {
	return $("#text_host").val();
}

function port() {
	return $("#text_port").val();
}

function remote() {
    return $("#remote")[0].checked;
}

function rpc(){
	return "http://" + $("#text_host").val() + ":" + $("#text_port").val();
}

function json_rpc(name, params, fun) {
    return rpc_call(rpc(), name, params, fun);
}

var g_receipt;

function transReceipt(){
    console.log('transReceipt');
    console.log('url=', g_receipt.url, 'params=', g_receipt.params, ",new Date().getTime()=", new Date().getTime());
    rpc_call(g_receipt.url, "eth_getTransactionReceipt", g_receipt.params, function (err, result) {
        console.log('err=', err, 'result=', result);
        if(!err){
            result = JSON.parse(result);
            if(result.result == null){
                console.log('null err=', err, 'res=', result);
                window.setTimeout("transReceipt()", 1000);
                return;
            }

            g_receipt.fun(err, result.result);
            return;
        }

        g_receipt.fun(err, result);
    });
}

var g_eth = {};

function query_con(){
    var url = rpc();
    if(g_eth[url] != undefined)
        return;

    rpc_call(url, "net_version", [], function (err, result) {
        if(err)
            return;

        result = JSON.parse(result);
        if(g_eth[url] == undefined)
            g_eth[url] = {"network":result.result};

        rpc_call(url, "personal_listAccounts", [], function (err, result) {
            if(err)
                return;

            result = JSON.parse(result);
            g_eth[url].accs = result.result;

            ajax("/web3/query", {"type":"cons","netword":g_eth[url].network}, function(XMLHttpRequest, textStatus){
                //console.log('XMLHttpRequest.responseText=', XMLHttpRequest.responseText);
                var result = JSON.parse(XMLHttpRequest.responseText);
                g_eth[url].cons = result;
                for(i in g_eth[url].cons){
                    g_eth[url].cons[i].contract_name = i;
                    g_eth[url].cons[i].address = g_eth[url].cons[i].networks[g_eth[url].network].address;
                }

                console.log('g_eth=', g_eth);
            })
        })
    })
}

function con_name(name){
    var url = rpc();
    if(g_eth[url] == undefined)
        return undefined;

    if(name == undefined)
        return g_eth[url].cons;

    console.log('name=', name);
    return g_eth[url].cons[name];

    rpc_call(url, "net_version", [], function (err, result) {
        if(err)
            return;

        result = JSON.parse(result);
        if(g_eth[url] == undefined)
            g_eth[url] = {"network":result.result};

        rpc_call(url, "personal_listAccounts", [], function (err, result) {
            if(err)
                return;

            result = JSON.parse(result);
            g_eth[url].accs = result.result;

            ajax("/cons", {"netword":g_eth[url].network}, function(XMLHttpRequest, textStatus){
                //console.log('XMLHttpRequest.responseText=', XMLHttpRequest.responseText);
                var result = JSON.parse(XMLHttpRequest.responseText);
                g_eth[url].cons = result;
                for(i in g_eth[url].cons)
                    g_eth[url].cons[i].contract_name = i;
                console.log('g_eth=', g_eth);
            })
        })
    })
}

function random_item(addr) // [Min, Max)
{
    console.log('addr.length=', addr.length);
    if(0 == addr.length)
        return undefined;

    var rand = Math.floor(Math.random() * (addr.length));
    console.log('rand=', rand, ",addr=", addr);
    return addr[rand];
}

function random_map(addr) // [Min, Max)
{
    var value = [];
    for(i in addr)
        value.push(i);

    if(0 == value.length)
        return undefined;

    var rand = Math.floor(Math.random() * value.length);
    return addr[value[rand]];
}

function trans_url(url, con, fun, data, callback){
    console.log('con=', con);
    var net = g_eth[url].network;
    console.log('con.networks=', con.networks);
    var to = con.networks[net].address;
    var from = random_item(g_eth[url].accs);

    var params = [{"from":from,"to":to,"data":data}];
    console.log('data=', data);
    rpc_call(url, "eth_sendTransaction", params, function (err, result){
        console.log('err=', err, 'result=', result);
        if(err){
            fun(err, result);
        }else{
            result = JSON.parse(result);
            result = [result.result];

            console.log('err=', err, 'result=', result, ",new Date().getTime()=", new Date().getTime());
            g_receipt = {"url":url,"params":result,"fun":callback};
            window.setTimeout("transReceipt()", 1);
        }

    });
}

function trans(con, fun, data, callback) {
    console.log('con=', con, ",fun=", fun);
    var url = rpc();
    trans_url(url, con, fun, data, callback);
}

function call_url(url, con, fun, data, callback){
    console.log('con=', con, ",fun=", fun);
    var net = g_eth[url].network;
    var to = con.networks[net].address;
    var from = random_item(g_eth[url].accs);

    var params = [{"from":from,"to":to,"data":data}, "-1"];
    console.log('data=', data);
    rpc_call(url, "eth_call", params, function (err, result){
        console.log('err=', err, 'result=', result);
        if(!err){
            result = JSON.parse(result);
            console.log('fun=', fun, ",result.result=", result.result);
            result = window.ethabi.decodeMethod(fun, result.result);
        }

        callback(err, result);
    });
}

function call(data, callback) {
    if(remote()){
        ajax('/web3/call',
            data,
            function(XMLHttpRequest, textStatus){
                var result = JSON.parse(XMLHttpRequest.responseText);
                callback(result.err, JSON.stringify(result.result, null, 4));
            }
        );
    }else{
        if(data[".rpc"] == undefined)
            data[".rpc"] = rpc();
        console.log('window.webs.prototype=', window.webs.prototype);
        console.log('data=', data, ",window.webs.call=", window.webs.call);

        window.webs.prototype.call(data, function (error, result) {
            console.log('error=', error, ",result=", result);
            if(typeof(result) === 'object')
                result = JSON.stringify(result, null, 4);
            callback(error, result);
        });
    }
}

function query(trans, callback) {
    try{
        if(remote()){
            var data = {".rpc":rpc(),"trans":trans};
            ajax('/web3/trans',
                data,
                function(XMLHttpRequest, textStatus){
                    console.log('XMLHttpRequest.responseText=', XMLHttpRequest.responseText);
                    var result = JSON.parse(XMLHttpRequest.responseText);
                    callback(result.err, result.result);
                }
            );
        }else{
            var webs = new window.webs.prototype.constructor(rpc());

            console.log('webs=', window.webs.prototype);
            console.log('trans=', trans, ",webs=", webs);

            webs.trans(trans, function (error, result) {
                console.log('error=', error, ",result=", result);
                callback(error, result);
            });
        }
    }catch(err){
        callback(true, err);
    }
}


function trans_1(trans, callback) {
    try{
        if(remote()){
            var data = {".rpc":rpc(),"trans":trans};
            ajax('/web3/trans',
                data,
                function(XMLHttpRequest, textStatus){
                    console.log('XMLHttpRequest.responseText=', XMLHttpRequest.responseText);
                    var result = JSON.parse(XMLHttpRequest.responseText);
                    callback(result.err, result.result);
                }
            );
        }else{
            var webs = new window.webs.prototype.constructor(rpc());

            console.log('webs=', window.webs.prototype);
            console.log('trans=', trans, ",webs=", webs);

            webs.trans(trans, function (error, result) {
                console.log('error=', error, ",result=", result);
                callback(error, result);
            });
        }
    }catch(err){
        callback(true, err);
    }
}

function test_1(args, callback) {
    try{
        if(remote()){
            ajax('/web3/test',
                args,
                function(XMLHttpRequest, textStatus){
                    console.log('XMLHttpRequest.responseText=', XMLHttpRequest.responseText);
                    var result = JSON.parse(XMLHttpRequest.responseText);
                    callback(result.err, result.result);
                }
            );

            return;
        }

        var id = args["id"];
        if(id !== undefined){
            res.send({"err":error, "result":webs.log(id)});
            return;
        }

        var count = Number(args["count"]);
        var perCount = Number(args["perCount"]);
        var conname = args[".contract"];
        var fun = args[".function"];
        var address = args["address"];

        var cons = g_eth[rpc()].cons;
        var webs = new window.webs.prototype.constructor(rpc());

        console.log('conname=', conname);
        if(conname === undefined){
            id = webs.test(count, perCount, cons);
        }else if(fun === undefined){
            id = webs.test_con(count, perCount, cons[conname]);
        }else{
            id = webs.test_fun(count, perCount, fun, conname, address);
        }

        console.log('id=', id);
        callback(false, id);
    }catch(err){
        console.log('err=', err);
        callback(true, err);
    }
};

function ajax(url, data, callback){
    console.log('data=', data);

	var rpcurl = rpc();
	if(data[".rpc"] == undefined)
		data[".rpc"] = rpcurl;
		
	$.ajax({    
		"url": url,    
		"type": 'get',    
		"dataType": 'json',   
		"contentType": 'application/json',    
		"data": data, 
		complete:function(XMLHttpRequest, textStatus){  
            if(textStatus == 'timeout'){  
                var xmlhttp = getRequest();
                xmlhttp.abort();   
				console.log('timeout');
				return;
			}
			
			try{
            	callback(XMLHttpRequest, textStatus);  
				save_url_array(rpcurl);
			}catch(err){
				console.log('err=', err);
			} 
        }
	});	
}

function rpccall(){
    console.log('rpccall');
    /*
    rpc_call("http://192.168.153.128:8545", "eth_blockNumber", [], function (err, result) {
        console.log('err=', err, 'result=', result);
    });
    return;*/
    var params = {"from":"0x18a3cbbf884d0fd94cd1d10dec041c3b5a08b5b5",
        "to":"0xb24a9cdd7d9b8a71ddd0f50479187ac4370a34e3",
        "data":"0x812600df0000000000000000000000000000000000000000000000000000000000000001"};
    $.ajax({
        "url":"http://192.168.153.128:8545",
        "type": 'post',
        "dataType": 'String',
        //"contentType": 'application/x-www-form-urlencoded',
        "contentType": 'application/json',
        /*
        xhrFields:{
            withCredentials:true
        },
        */
        crossDomain:true,
        //processData: false,
        "data": '{"jsonrpc":"2.0","id":"2","method":"eth_sendTransaction","params":[{"from":"0x18a3cbbf884d0fd94cd1d10dec041c3b5a08b5b5","to":"0xb24a9cdd7d9b8a71ddd0f50479187ac4370a34e3","data":"0x812600df0000000000000000000000000000000000000000000000000000000000000001"}]}',

        complete:function(XMLHttpRequest, textStatus){
            if(textStatus == 'timeout'){
                var xmlhttp = getRequest();
                xmlhttp.abort();
                console.log('timeout');
                return;
            }

            console.log('textStatus=', textStatus);
            console.log('XMLHttpRequest=', XMLHttpRequest);
            console.log('XMLHttpRequest.responseText=', XMLHttpRequest.responseText);
        }
    });
}

function log(id, remote, callback){
    if(!remote){
        console.log('window.webs.prototype=', window.webs.prototype);
        console.log('window.webs.prototype.logs=', window.webs.prototype.logs);
        callback(false, window.webs.prototype.logs[id]);
        return;
    }

	ajax('/web3/query',
		{"type":"log","id":id,"remove":"true"},
		function(XMLHttpRequest, textStatus){
			console.log('XMLHttpRequest.responseText=', XMLHttpRequest.responseText);
			try{
                callback(false, JSON.parse(XMLHttpRequest.responseText));
			}catch(err){
				console.log('err=', err);
                callback(true, err);
			}
        }
	);
}

function time_get_log(id, remote){
    window.log(id, remote,
        function(err, result){
            console.log('err=', err, 'typeof(result)=', typeof(result), 'result=', result);
            console.log("*******************err=", err, "result.count=", result.count, "result.req_count=", result.req_count, ",str=", str);
            window.logback(err, result);
            if(!err && result.count < result.req_count){

                var str = "time_get_log(" + id + ", false)";
                if(remote)
                    str = "time_get_log(" + id + ", true)";

                window.setTimeout(str, 1000);
            }
        }
    );
}

function time_log(id, remote, callback){
    window.logback = callback;

    window.log(id, remote,
        function(err, result){
            console.log('err=', err, 'typeof(result)=', typeof(result), 'result=', result);
            console.log("*******************err=", err, "result.count=", result.count, "result.req_count=", result.req_count, ",str=", str);
            window.logback(err, result);
            if(!err && result.count < result.req_count){

                var str = "time_get_log(" + id + ", false)";
                if(remote)
                    str = "time_get_log(" + id + ", true)";

                window.setTimeout(str, 1000);
            }
        }
    );
}

function onDeviceReady() {
	var strKey = url_key(); 
	var storage = window.localStorage; 
	var value = storage.getItem(strKey);
	
	console.log('value=', value, '$("#text_host")=', $("#text_host"));
	if(value==null)
		return;
		
	var strs= value.split(",");
	var select = document.getElementById("url_list"); 
	for(var i=0;i<strs.length ;i++ ){
		if(strs[i].length > 0){
			if(i == 0){
				set_url(strs[i]);
				inserted = true;
			}
			url_array.push(strs[i]);
			select.add(new Option(strs[i],""));
		}
	}

    query_con();
}

function save_url_array(url)
{
	if(url.indexOf('//')){
		console.log('url=', url);
		url = url.substring(url.indexOf('//')+2);
	}
		
	var strKey = url_key(); 
	console.log('url=', url, ",window.location.host=", window.location.host, ",window.location.port=", window.location.port);
	if(url_array[0] == url)
		return;

	removeByValue(url_array, url);
	url_array.unshift(url);
	var strValue = '';
	
	url_array.forEach(function (element, index, array) {  
		// element: 指向当前元素的值  
		// index: 指向当前索引  
		// array: 指向Array对象本身  
		if(strValue.length > 0){
			strValue = strValue + ',' + element;
		}else{
			strValue = element;
		} 
	});
	
	console.log('url=', url, 'strValue=', strValue);
	var storage = window.localStorage; 
	storage.setItem(strKey, strValue);
	set_select();
}

function on_change(obj)
{
	var id = obj.options.selectedIndex;
	var text = obj.options[id].text;
	
	//this.options[this.options.selectedIndex].value
	set_url(text);
	console.log("obj=", obj, "id=", id, "text=", text);
}

function jump_url(obj){
	console.log("obj.name=", obj.name);
	document.getElementById("main_frame").src = obj.name;
}


function stat_init(req_count) {
    return {"id": new Date().getTime(),
        "start": new Date().getTime(),
        "req_count": req_count,
        "count": 0,
        "err": 0,
        "nolog": 0,
        "succeed": 0,
        "gasUsed" : 0,
        "costTime" : 0,
        "contract": {}};
}

function stat_stat(stat, arg) {
    stat.costTime = new Date().getTime() - stat.start;
    var funname = arg.fun.name;
    var conname = arg.con.contract_name;
    if(typeof stat.contract[conname] === "undefined"){
        stat.contract[conname] = {count:0, err:0, nolog:0, succeed:0, gasUsed : 0, function:{}};
    }

    if(typeof stat.contract[conname].function[funname] === "undefined"){
        //logs.log("conname=", conname, ",funname=", funname)
        if(arg.fun.constant)
            stat.contract[conname].function[funname] = {count: 0, err: 0, succeed: 0};
        else
            stat.contract[conname].function[funname] = {count: 0, err: 0, nolog:0, succeed: 0, gasUsed : 0};
    }

    stat.count++;
    stat.contract[conname].count++;
    stat.contract[conname].function[funname].count++;

    if(arg.err){
        stat.err++;
        stat.contract[conname].err++;
        stat.contract[conname].function[funname].err++;
        //logs.log("stat=", logs.inspect(stat));
        return stat;
    }

    console.log('arg=', arg);
    if(arg.fun.constant ==  false && arg.result.logs.length == 0){
        stat.nolog++;
        stat.contract[conname].nolog++;
        stat.contract[conname].function[funname].nolog++;
        //logs.log("stat=", logs.inspect(stat));
        return stat;
    }

    stat.succeed++;
    stat.contract[conname].succeed++;
    stat.contract[conname].function[funname].succeed++;

    if(!arg.fun.constant){
        var gasUsed = Number(arg.result.gasUsed);
        if(gasUsed == undefined)
            gasUsed = 0;

        stat.gasUsed += gasUsed;
        stat.contract[conname].gasUsed += gasUsed;
        stat.contract[conname].function[funname].gasUsed += gasUsed;
        //logs.log("stat=", logs.inspect(stat));
        return stat;
    }

    //logs.log("stat=", logs.inspect(stat));
    return stat;
}

function stat_trans(url, con, fun, arg, callback) {
    console.log("fun=", fun);
    var f = trans_url;
    if(fun.constant)
        f = call_url;

    f(url, con, fun, arg, function(err, result){
        //logs.log("result=", result);
        arg = {"con": con,
            "fun": fun,
            "err": false,
            "result": result};

        callback(arg);
    });
}

function pressure_test_transaction(url, con, con_fun, count, perCount, callback) {
    var back_count = 0;

    for(var i = 0; i < perCount; i++){
        var params = window.ethabi.random(con_fun);
        stat_trans(con, con_fun, params, function (result) {
            g_eth[url].stat = stat_stat(g_eth[url].stat, result);

            back_count++;
            assert.ok(back_count <= perCount, "back_count > perCount");
            if(back_count >= perCount){

                if(count > 1){
                    pressure_test_transaction(url, con, con_fun, count-1, perCount, callback);
                }else{
                    callback(g_eth[url].stat);
                }

            }
        });
    }
}

function pressure_test_contract(url, con, count, perCount, callback) {

    var back_count = 0;

    for(var i = 0; i < perCount; i++){
        var abi = random_item(con.abi);
        console.log("con=", con, ",abi=", abi);
        var params = window.ethabi.random(abi);
        //var number = utils.get_random_num(0, abi.length);
        //logs.logvar(number, abi.length);
        //logs.logvar(number, abi.length, count, i);

        stat_trans(url, con, abi, params, function (result) {
            g_eth[url].stat = stat_stat(g_eth[url].stat, result);

            back_count++;
            if(back_count >= perCount){
                //logs.logvar(count, result.con.contract_name, result.fun.name);

                if(count > 1){
                    pressure_test_contract(url, con, count-1, perCount, callback);
                }else{
                    callback(g_eth[url].stat);
                }
            }
        });
    }
}

function pressure_test(url, count, perCount, callback) {
    var con = random_map(g_eth[url].cons);
    if(con == undefined){
        return;
    }

    //res.send(stat.id);
    console.log("con=", con);
    pressure_test_contract(url, con, 1, perCount, function (result) {
        //logs.logvar(stat, result);
        //stat = trans.stat_add(stat, result);
        //logs.logvar(count, perCount, name);
        if(count > 1){
            pressure_test(url, count-1, perCount, callback);
        }else{
            callback(g_eth[url].stat);
        }
    });
}

function log_url(id, url){
    //return g_eth[url].stat;
    return g_eth[url].stat;
}

function test(count, perCount) {
    var url = rpc();
    var begin = new Date().getTime();
    g_eth[url].stat = stat_init(count*perCount);

    console.log(count, perCount);
    pressure_test(url, count, perCount, function (result) {
        var end = new Date().getTime();
        result.costTime = end - begin;
        g_eth[url].stat = result;
        //logs.log("result=", logs.inspect(result));
        //res.send(result);
    });
}


</script>

<style type="text/css">
	html
	{
	 height:100%;
	 margin:0;
	}
	body
	{
		height:100%;
		margin:0; 
	}
	
	hr{ border-top:1px solid #987cb9;}
	
	.a{ width:38%; float:left;border:1px solid green;height:100%;}
	.b{ width:60%; margin-left:38%;border:1px solid orange;height:100%;}
</style>

</head>

<body>
<div align="center">
<p>
	<input type="text" id="text_host" value="192.168.1.1"> </input>
	<input type="number" id="text_port" min="1" max="65535" value="8545"> </input>
    <select id="url_list" onChange="on_change(this)"></select>

    remote:<input class="input" id="remote" type="checkbox">

    <button name="web3.html" onClick="jump_url(this)">web3</button>
    <button name="contract.html" onClick="jump_url(this)">contract</button>
    <button name="contract_list.html" onClick="jump_url(this)">contract_test</button>
    <button name="test_stress.html" onClick="jump_url(this)">test stress</button>
    <a href="Mailto:ancjf@163.com">Contact me!</a>
    <a href="/web3/example/balance.html">contract_array</a>
</p>

<iframe id="main_frame" width="98%" height="95%" src="/web3.html"></iframe>

</div>

<script type="text/javascript">
$(document).ready(function(){
	onDeviceReady();
});

</script>
</body>

</html>