<html>

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta http-equiv="Access-Control-Allow-Methods" content="POST,GET">
    <script src="./javascripts/web3-provider.min.js"></script>
    <script src="./javascripts/ethers-5.2.umd.min.js"></script>

    <style type="text/css">
        html {
            height: 100%;
            margin: 0;
        }

        body {
            top: 10px;
            height: 100%;
            margin: 0;
        }

        hr {
            border-top: 1px solid #987cb9;
        }

        .div {
            padding: 20px;
        }

        .btn {
            font-size: 14px;
            color: #000;
            height: 44px;
            width: 240px;
            padding: 0 15px;
            background-color: yellow;
            border: 1px solid yellow;
            line-height: 1.2;
            text-align: center;
            border-radius: 2px;
            cursor: pointer;
            transition: opacity 0.2s;
            outline: none;
            position: relative;

        }

        .btn::before {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background-color: #000;
            border: inherit;
            border-color: #000;
            border-radius: inherit;
            transform: translate(-50%, -50%);
            opacity: 0;
            content: ' ';
        }

        .btn:active::before {
            opacity: 0.1;
        }
    </style>

    <script type="module">

        //import { WalletConnectConnector } from './javascripts/walletconnect-connector.esm.js';
        //import { ethers } from "https://cdn.ethers.io/lib/ethers-5.2.esm.min.js";
        //https://docs.metamask.io/guide/ethereum-provider.html#methods
        //https://docs.ethers.io/v5/getting-started/
        document.querySelector('#connect').addEventListener('click', async () => {
            try {
                const WalletConnectProvider = window.WalletConnectProvider.default;
                console.log('window.WalletConnectProvider:', window.WalletConnectProvider);
                const WalletConnect = new WalletConnectProvider({
                    chainId: 56,
                    rpc: { //1: "https://api.mycryptoapi.com/eth",
                        56: "https://bsc-dataseed1.ninicoin.io",
                        //97: "https://data-seed-prebsc-2-s2.binance.org:8545/",
                    },
                    qrcode: true,
                    pollingInterval: 12000,
                });

                const accounts = await WalletConnect.enable();
                //events: connect, disconnect, session_request, session_update, call_request, wc_sessionRequest, wc_sessionUpdate
                WalletConnect.on('disconnect', (error, result)=>{
                    console.log('error:', error, ',result:', result);
                })

                const provider = new ethers.providers.Web3Provider(WalletConnect);
                console.log('provider:', provider, ',provider.getBalance:', provider.getBalance, ',accounts:', accounts, ',WalletConnect:', WalletConnect);

                window.provider = provider;
                window.WalletConnect = WalletConnect;

                const balance = await provider.getBalance(accounts[0]);
                console.log("balance:", balance);
            } catch (e) {
                console.log('e:', e);
            }
        });

        document.querySelector('#sendTransaction').addEventListener('click', async () => {
            try {
                if (window.WalletConnect == null) {
                    //没安装MetaMask钱包进行弹框提示
                    return alert("请先连接");
                }

                const provider = window.provider;
                const signer = provider.getSigner();
                console.log("signer:", signer, ',ethers.utils.parseUnits(2, 0):', ethers.utils.parseUnits('2', 0));

                const tx = await signer.sendTransaction({
                    to: "0xa2847B58f13020f3bbcd116A1f7319D6d6aeb180",
                    //value: ethers.utils.parseEther("0.001")
                    value: ethers.utils.parseUnits('2', 0)
                })
                console.log("tx:", tx);
                document.getElementById('result').textContent = JSON.stringify(tx, null, 4);
            } catch (e) {
                console.log('e:', e);
            }
        });

        document.querySelector('#balance').addEventListener('click', async () => {
            try {
                if (window.WalletConnect == null) {
                    //没安装MetaMask钱包进行弹框提示
                    return alert("请先连接");
                }

                const provider = window.provider;
                const tx = await provider.getBalance("0xa2847B58f13020f3bbcd116A1f7319D6d6aeb180")
                console.log("tx:", tx);

                document.getElementById('result').textContent = JSON.stringify(tx, null, 4);
            } catch (e) {
                console.log('e:', e);
            }
        });

        document.querySelector('#contract').addEventListener('click', async () => {
            try {
                if (window.WalletConnect == null) {
                    //没安装MetaMask钱包进行弹框提示
                    return alert("请先连接");
                }

                const provider = window.provider;
                const signer = provider.getSigner();
                const address = "0x4cc2223682617038AD93bE86866dA5CA01436B61";
                const erc20Abi = [
                    // Some details about the token
                    "function name() view returns (string)",
                    "function symbol() view returns (string)",

                    // Get the account balance
                    "function balanceOf(address) view returns (uint)",
                    "function buy(uint256 ticket, uint256 period, bool direct) payable",

                    // Send some of your tokens to someone else
                    "function transfer(address to, uint amount)",

                    // An event triggered whenever anyone transfers to someone else
                    "event Transfer(address indexed from, address indexed to, uint amount)"
                ];
                const linkContract = new ethers.Contract(address, erc20Abi, provider);
                const value = ethers.utils.parseUnits("0.001", 18);
                const contractSigner = linkContract.connect(signer);
                //const erc20tx = await contractSigner.transfer("0xa2847B58f13020f3bbcd116A1f7319D6d6aeb180", value);
                const erc20tx = await contractSigner.buy('3452345', 1, true, {value: ethers.utils.parseEther('0.0001')});

                console.log("erc20tx:", erc20tx);
                document.getElementById('result').textContent = JSON.stringify(erc20tx, null, 4);
            } catch (e) {
                console.log('e:', e);
            }
        });

        document.querySelector('#call').addEventListener('click', async () => {
            try {
                if (window.provider == null) {
                    //没安装MetaMask钱包进行弹框提示
                    return alert("请先连接");
                }

                const provider = window.provider;
                const address = "0x4cc2223682617038AD93bE86866dA5CA01436B61";
                const erc20Abi = [
                    // Some details about the token
                    "function name() view returns (string)",
                    "function symbol() view returns (string)",

                    // Get the account balance
                    "function balanceOf(address, uint256 id) view returns (uint)",

                    // Send some of your tokens to someone else
                    "function transfer(address to, uint amount)",

                    // An event triggered whenever anyone transfers to someone else
                    "event Transfer(address indexed from, address indexed to, uint amount)"
                ];
                const linkContract = new ethers.Contract(address, erc20Abi, provider);
                const erc20tx = await linkContract.balanceOf("0xa2847B58f13020f3bbcd116A1f7319D6d6aeb180", 100);

                console.log("erc20tx:", erc20tx);
                document.getElementById('result').textContent = JSON.stringify(erc20tx, null, 4);
            } catch (e) {
                console.log('e:', e);
            }
        });

        document.querySelector('#disconnect').addEventListener('click', async () => {
            try {
                if (window.WalletConnect == null) {
                    //没安装MetaMask钱包进行弹框提示
                    return alert("请先连接");
                }

                await window.WalletConnect.disconnect();
                window.disconnect = null;
                window.WalletConnect = null;
            } catch (e) {
                console.log('e:', e);
            }
        });

    </script>
</head>

<body>
<div align="center" class="div">
    <p>
        <button class="btn" id="connect">test connect</button>
    </p>

    <p>
        <button class="btn" id="sendTransaction">test sendTransaction</button>
    </p>

    <p>
        <button class="btn" id="balance">test balance</button>
    </p>

    <p>
        <button class="btn" id="contract">test contract</button>
    </p>

    <p>
        <button class="btn" id="call">test contract call</button>
    </p>

    <p>
        <button class="btn" id="disconnect">test disconnect</button>
    </p>

    <p>
        <text id="result"></text>
    </p>
</div>
</body>

</html>
