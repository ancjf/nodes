<html>

<head>
    <meta charset="utf-8"/>
	<script type="text/javascript" src="javascripts/jquery-3.2.1.min.js"></script>
<script>

var g_con;
var g_abis;

function QueryString(item){
	var svalue = location.search.match(new RegExp("[\?\&]" + item + "=([^\&]*)(\&?)","i"));
	return svalue ? svalue[1] : "";
}

function set_table(text, index) {
    return  '<form action="/pressure_test/test" method="get" id = "' + index.toString() + '" onsubmit="return on_submit(this);">  <table border="0" cellspacing="5" cellpadding="5" style="border:1px #666666 solid;"><tr> <td>count:</td>  <td> <input id="count" type="number" value="5" min="1" ></td></tr><tr><td>perCount:</td>  <td> <input id="perCount" type="number" value="5" min="1" ></td></tr><tr> <td> <input type="submit" id="text" value="' + text + '" />  </td> </tr> </table> </form>';
}

function set_contracts(con){
    g_con = con;
	
	var html = set_table(QueryString("name"), -1);
	for(var i=0; i<g_con.abi.length; i++){
		var type = g_con.abi[i].constant ? 'call' : 'transaction';
		var text = QueryString("name") + '.' + g_con.abi[i].name + '.' + type;
		html += set_table(text, i);
	}
	
	//console.log('html=', html);
	$("#left_list").html(html);
}

function onDeviceReady() {
	console.log('list:window.parent=', window.parent);

	var name = QueryString("name");
	var con = window.parent.con_name(name);
    console.log('name=', name, 'con=', con);
    set_contracts(con);
    return;
	
	window.parent.ajax('/pressure_test/query', 
		{"name":QueryString("name")},
		function(XMLHttpRequest, textStatus){
			//console.log('XMLHttpRequest.responseText=', XMLHttpRequest.responseText);
            set_contracts(JSON.parse(XMLHttpRequest.responseText));   
        }
	);
}

var time_id;

function precoss_result(objResult, id, remote){
	var result = JSON.stringify(objResult, null, 4);
	//console.log("result.length=", result.length, "result=", result);
	if(result.length)
		$("#result_text").text(result);

    if(objResult.count < objResult.req_count){
        console.log("*******************objResult.count=", objResult.count, "objResult.req_count=", objResult.req_count, ",time_id=", time_id);

        var str = "time_get_log(" + id + ", false)";
        if(remote)
            str = "time_get_log(" + id + ", true)";
        window.setTimeout(str, 1000);
    }
}

function time_get_log(id, remote){
    console.log('id=', id, 'remote=', remote);

    window.parent.log(id, remote,
        function(err, result){
            console.log('err=', err, 'typeof(result)=', typeof(result), 'result=', result);
            precoss_result(result, id, remote);
        }
    );
}

function on_submit(obj)
{
	if(time_id != undefined){
		console.log("time_id=", time_id);
		clearInterval(time_id);
		time_id = undefined;
	}
	
	var id = parseInt($(obj)[0].id);
	var count = $(obj).find("#count")[0].value;
	var perCount = $(obj).find("#perCount")[0].value;
	var text = $(obj).find("#text")[0].value;
	var contract = text.split(".")[0];
	var rpc = window.parent.rpc();
	var args = {".rpc":rpc,"count":count,"perCount":perCount,".contract":contract};
	if(id >= 0){
        args[".function"] = g_con.abi[id];
        args["address"] = g_con.address;
    }

	
	console.log('count=', count, 'perCount=', perCount, ',text=', text, ",contract=", contract);

    window.parent.test_1(args, function (err, result) {
        if(err){
            $("#result_text").text(result);
            return;
        }

        var id = result;
        var remote = window.parent.remote();
        window.parent.time_log(id, remote, function (err, result) {
            var result = JSON.stringify(result, null, 4);
            //console.log("result.length=", result.length, "result=", result);
            if(result.length)
                $("#result_text").text(result);
        });

        return;


        var str = "time_get_log(" + id + ", false)";
        if(window.parent.remote())
            str = "time_get_log(" + id + ", true)";

        console.log('err=', err, 'result=', result, ",str=", str);
        window.setTimeout(str, 1000);
    });

    return false;
	
	window.parent.ajax('/pressure_test/test', 
		reqdata,
		function(XMLHttpRequest, textStatus){
			console.log('XMLHttpRequest.responseText=', XMLHttpRequest.responseText);
            $("#result_text").text(XMLHttpRequest.responseText);
			time_id = setInterval("time_get_log(" + XMLHttpRequest.responseText + ")", 1000);
        }
	);
	
	return false;
}

</script>

<style type="text/css">
	html
	{
	 height:100%;
	 margin:0;
	}
	body
	{
		height:99%;
		margin:0; 
	}
	
	hr{ border-top:1px solid #987cb9;}
	
	.left{ width:38%; float:left;border:1px solid green;height:100%;}
	.right{ width:60%; margin-left:38%;border:1px solid orange;height:100%;}
	
	#result_text {  
    width: 100%; /*自动适应父布局宽度*/  
	height: 100%;
    overflow: auto;  
    word-break: break-all;  
    /*在ie中解决断行问题(防止自动变为在一行显示，主要解决ie兼容问题，ie8中当设宽度为100%时，文本域类容超过一行时，当我们双击文本内容就会自动变为一行显示，所以只能用ie的专有断行属性“word-break或word-wrap”控制其断行)*/  
	} 
</style>

</head>

<body>
<div align="center">

<div class="w">
	<div class="left"><div align="left">
    
    <div align="middle", style="overflow:auto;" id="left_list">
    </div>
                              
    </div></div>
    <div class="right"><textarea id="result_text"></textarea></div>
    
</div>


</div>

<script type="text/javascript">
$(document).ready(function(){
	onDeviceReady();
});

</script>
</body>

</html>