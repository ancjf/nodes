<html>

<head>
    <meta charset="utf-8"/>
	<script type="text/javascript" src="javascripts/jquery-3.2.1.min.js"></script>
<script>
var xhr = null;                 
try{    
	xhr = new ActiveXObject("Msxml2.XMLHTTP");    
}catch(e){    
	try{    
		xhr = new ActiveXObject("Microsoft.XMLHTTP");    
	}catch(e){}    
}
  
if (!xhr) 
	xhr = new XMLHttpRequest();

function set_contracts(con){
	console.log('con=', con);
	
	var html = '';
	for(var i=0;i<con.length;i++){
		html += '<form action="/contract_test.html" method="get"><input type="submit" name="name" style="font-size:20px;width:200px;" value="' + con[i] + '"> </form>';
	}
	
	$("#left_list").html(html);
}

function onDeviceReady() {
	console.log('list:window.parent=', window.parent);
	
	$.ajax({    
		url: '/pressure_test/query',    
		type: 'get',    
		dataType: 'json',   
		contentType: 'application/json',    
		data: {}, 
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			console.log("XMLHttpRequest.status=", XMLHttpRequest.status, ",XMLHttpRequest.readyState=", XMLHttpRequest.readyState, ",textStatus=", textStatus, ",XMLHttpRequest=", XMLHttpRequest);
   		},   
		success: function(objResult) {
			//console.log("objResult=", objResult);
			set_contracts(objResult);
		}
	});	
}

var time_id;

function precoss_result(objResult){
	if(objResult.count >= objResult.req_count){
		console.log("*******************objResult.count=", objResult.count, "objResult.req_count=", objResult.req_count, ",time_id=", time_id);
		clearInterval(time_id);
	}
	
	var result = JSON.stringify(objResult, null, 4);
	//console.log("result.length=", result.length, "result=", result);
	if(result.length)
		$("#result_text").text(result);
}

function time_get_log(id){
	console.log('id=', id);
	
	$.ajax({    
		url: '/pressure_test/log',    
		type: 'get',    
		dataType: 'json',   
		contentType: 'application/json',    
		data: {"id":id,"remove":"true"}, 
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			console.log("XMLHttpRequest.status=", XMLHttpRequest.status, ",XMLHttpRequest.readyState=", XMLHttpRequest.readyState, ",textStatus=", textStatus, ",XMLHttpRequest=", XMLHttpRequest);
			if(XMLHttpRequest.status == 200 && XMLHttpRequest.readyState == 4 && XMLHttpRequest.responseText != ''){
				$("#result_text").text(XMLHttpRequest.responseText);
			}
   		},   
		success: function(objResult) {
			//console.log("objResult=", objResult);
			precoss_result(objResult);
		}
	});	
}

function on_submit(obj)
{
	if(time_id != undefined){
		console.log("time_id=", time_id);
		clearInterval(time_id);
		time_id = undefined;
	}
	
	var count = $(obj).find("#count")[0].value;
	var perCount = $(obj).find("#perCount")[0].value;
	
	console.log('count=', count, 'perCount=', perCount, ',$(obj).find("#count")=', $(obj).find("#count"));
	
	$.ajax({    
		url: '/pressure_test/test',    
		type: 'get',    
		dataType: 'json',   
		contentType: 'application/json',    
		data: {"count":count,"perCount":perCount}, 
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			console.log("XMLHttpRequest.status=", XMLHttpRequest.status, ",XMLHttpRequest.readyState=", XMLHttpRequest.readyState, ",textStatus=", textStatus, ",XMLHttpRequest=", XMLHttpRequest);
			if(XMLHttpRequest.status == 200 && XMLHttpRequest.readyState == 4 && XMLHttpRequest.responseText != ''){
				$("#result_text").text(XMLHttpRequest.responseText);
				time_id = setInterval("time_get_log(" + XMLHttpRequest.responseText + ")", 1000);
				//setTimeout("time_get_log(" + result + ")", 1000);
			}
   		},   
		success: function(objResult) {
			console.log("objResult=", objResult);
			var result = JSON.stringify(objResult, null, 4);
			console.log("result.length=", result.length, "result=", result);
			$("#result_text").text(result);
			
			if(objResult != null && objResult != undefined && result != ''  && result != '{}'){
				time_id = setInterval("time_get_log(" + result + ")", 1000);
				//setTimeout("time_get_log(" + result + ")", 1000);
			}else{
				console.log("recv err");
			}
		}
	});
	
	return false;
}

</script>

<style type="text/css">
	html
	{
	 height:100%;
	 margin:0;
	}
	body
	{
		height:99%;
		margin:0; 
	}
	
	hr{ border-top:1px solid #987cb9;}
	
	.left{ width:38%; float:left;border:1px solid green;height:100%;}
	.right{ width:60%; margin-left:38%;border:1px solid orange;height:100%;}
	
	#result_text {  
    width: 100%; /*自动适应父布局宽度*/  
	height: 100%;
    overflow: auto;  
    word-break: break-all;  
    /*在ie中解决断行问题(防止自动变为在一行显示，主要解决ie兼容问题，ie8中当设宽度为100%时，文本域类容超过一行时，当我们双击文本内容就会自动变为一行显示，所以只能用ie的专有断行属性“word-break或word-wrap”控制其断行)*/  
	} 
</style>

</head>

<body>
<div align="center">

<div class="w">
	<div class="left"><div align="left">
    
    <div align="middle", id="left_list"></div>
                           
    </div></div>
    <div class="right"><textarea id="result_text"></textarea></div>
    
</div>


</div>

<script type="text/javascript">
$(document).ready(function(){
	onDeviceReady();
});

</script>
</body>

</html>