<html>

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="Access-Control-Allow-Origin" content="192.168.153.128">
    <meta http-equiv="Access-Control-Allow-Methods" content="POST,GET">
	<script type="text/javascript" src="javascripts/jquery-3.2.1.min.js"></script>
    <script type="text/javascript" src="javascripts/json_rpc.js"></script>
<script>

function set_fun(name, fun){
    var tc = 'fun';
    if(fun.params.length > 0)
        tc = 'funs';
    //var ret = '<form action="/" name="' + name + '" onsubmit="return on_submit(this);"> <table class="' + tc + '">';
    var ret = '<form action="/" name="' + name + '" onsubmit="return on_submit(this);"> <table class="' + tc + '">';

    for(var i=0;i<fun.params.length ;i++ ){
        var reminder = typeof(fun.params[i]);
        var text = fun.params[i];

        //console.log('fun.params=', fun.params, ',typeof(fun.params[i]=', typeof(fun.params[i]));
        if(typeof(fun.params[i]) == "string")
            ret += '<tr><td> <input class="input" name="' + reminder + '" type="text"></td></tr>';
        else
            ret += '<tr><td> <input class="input" name="' + reminder + '" type="checkbox"></td></tr>';
    }

    var funname = name;
    ret += '<tr> <td> <input type="submit" id="submitName" value="'  + funname + '">  </td></tr></table></form>';
    return ret;
}

function set_funs() {
    var funs = rpc_funs();

    var html = '';
    for(var value in funs) {
        html += set_fun(value, funs[value]);
    }

    $("#funs").html(html);
}

function test_funs() {
    const SimpleStoreABI = [{"constant":false,"inputs":[{"name":"_value","type":"uint256"}],"name":"set","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"get","outputs":[{"name":"storeValue","type":"uint256"}],"payable":false,"type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"name":"_newValue","type":"uint256"},{"indexed":false,"name":"_sender","type":"address"}],"name":"SetComplete","type":"event"}];

    const abi = window.parent.ethabi;
    console.log('abi=', abi);
    const setInputBytecode = abi.encodeMethod(SimpleStoreABI[0], [24000]);
    console.log('setInputBytecode=', setInputBytecode);
// returns 0x60fe47b10000000000000000000000000000000000000000000000000000000000005dc0

    const setOutputBytecode = abi.decodeMethod(SimpleStoreABI[0], "0x0000000000000000000000000000000000000000000000000000000000000001");
    console.log('setOutputBytecode=', setOutputBytecode);
    console.log('abi.random(SimpleStoreABI[0])=', abi.random(SimpleStoreABI[0]));

// returns  Result { '0': true }



    const getInputBytecode = abi.encodeMethod(SimpleStoreABI[1], []);
    console.log('getInputBytecode=', getInputBytecode);
    console.log('abi.random(SimpleStoreABI[1])=', abi.random(SimpleStoreABI[1]));
// returns 0x6d4ce63c

    const getMethodOutputBytecode = abi.decodeMethod(SimpleStoreABI[1], "0x000000000000000000000000000000000000000000000000000000000000b26e");
    console.log('getMethodOutputBytecode=', getMethodOutputBytecode);
// returns Result { '0': <BN: b26e>, storeValue: <BN: b26e> }



    const SetCompleteInputBytecode = abi.encodeEvent(SimpleStoreABI[2], [24000, "0xca35b7d915458ef540ade6068dfe2f44e8fa733c"]);
    console.log('SetCompleteInputBytecode=', SetCompleteInputBytecode);
    console.log('abi.random(SimpleStoreABI[2])=', abi.random(SimpleStoreABI[2]));
// returns 0x10e8e9bc0000000000000000000000000000000000000000000000000000000000005dc0000000000000000000000000ca35b7d915458ef540ade6068dfe2f44e8fa733c

    const SetCompleteOutputBytecode = abi.decodeEvent(SimpleStoreABI[2], "0x0000000000000000000000000000000000000000000000000000000000000d7d000000000000000000000000ca35b7d915458ef540ade6068dfe2f44e8fa733c");
    console.log('SetCompleteOutputBytecode=', SetCompleteOutputBytecode);
    /* returns   Result {
  '0': <BN: d7d>,
  '1': '0xca35b7d915458ef540ade6068dfe2f44e8fa733c',
  _newValue: <BN: d7d>,
  _sender: '0xca35b7d915458ef540ade6068dfe2f44e8fa733c' }
*/

}

function onDeviceReady() {
	console.log('list:window.parent=', window.parent, ",window.parent.url_key()=", window.parent.url_key());
    test_funs();
    //set_funs();

    var data = window.parent.ethabi.random({
        "constant": false,
        "inputs": [
            {
                "name": "val",
                "type": "int256"
            }
        ],
        "name": "set",
        "outputs": [
            {
                "name": "",
                "type": "int256"
            }
        ],
        "payable": false,
        "type": "function"
    });

    console.log('data=', data);
    console.log('window.parent.webs=', window.parent.webs);
	return;
	var strKey = "url_array"; 
	var storage = window.localStorage; 
	var value = storage.getItem(strKey);
	
	console.log('value=', value, '$("#text_host")=', $("#text_host"));
	if(value==null)
		return;
		
	var strs= value.split(",");
	var select = document.getElementById("url_list"); 
	for(var i=0;i<strs.length ;i++ ){
		if(strs[i].length > 0){
			if(i == 0){
				set_url(strs[i]);
				inserted = true;
			}
			url_array.push(strs[i]);
			select.add(new Option(strs[i],""));
		}
	}
}

function on_submit_remote(fun, params)
{
    console.log('fun=', fun, 'params=', params);
    window.parent.ajax('/web3/',
        {"fun":fun,"params":JSON.stringify(params)},
        function(XMLHttpRequest, textStatus){
            var result = XMLHttpRequest.responseText;
            console.log('result=', result);

            result = JSON.parse(result);
            result = result.result;
            if(typeof(rpc_ret(fun)) == 'object'){
                result = JSON.stringify(result, null, 4);
            }
            $("#result_text").text(result);
        }
    );

    return false;
}

function on_submit(obj)
{
    var arr = $(obj).children("input");
    var params = [];
    var fun = $(obj)[0].name;
    var type = $(obj)[0].className;

    for(var i=0;i<arr.length;i++){
        if(arr[i].type == 'submit')
            continue;

        var value = arr[i].value;
        params.push(value);
    }

    var data = {"fun":fun,"params":params,"type":type};
    window.parent.call(data, function(error, result){
        $("#result_text").text(result);
    });

    return false;

    console.log('fun=', fun, 'params=', params, 'type=', type);
    window.parent.ajax('/web3/call',
        {"fun":fun,"params":params,"type":type},
        function(XMLHttpRequest, textStatus){
            var result = JSON.stringify(JSON.parse(XMLHttpRequest.responseText), null, 4);
            $("#result_text").text(result);
        }
    );

    return false;
}

function on_submit_bak(obj)
{
    var arr = $(obj).children("input");
    var arg = '';
    var fun = $(obj)[0].name;
    var type = $(obj)[0].className;

    for(var i=0;i<arr.length;i++){
        if(arr[i].type == 'submit')
            continue;

        var value = arr[i].value;
        //console.log('value=', value, 'arg=', arg, ',arr=', arr);
        if(value == null || 0 == value.length)
            value = '""';
        else
            value = '"' + value + '"';

        if(arg.length){
            arg = arg + ',' + value;
        }else{
            arg = value;
        }
    }

    console.log('fun=', fun, 'arg=', arg, 'type=', type);
    window.parent.ajax('/web3/call',
        {"fun":fun,"arg":arg,"type":type},
        function(XMLHttpRequest, textStatus){
            var result = JSON.stringify(JSON.parse(XMLHttpRequest.responseText), null, 4);
            $("#result_text").text(result);
        }
    );

    return false;
}

function on_trans(obj)
{
    var text = $(obj).find("#trans")[0].value;
    JSON.stringify(JSON.parse(text));
    console.log("text=", text);

    window.parent.ajax('/web3/trans',
        {"trans":text},
        function(XMLHttpRequest, textStatus){
            var result = JSON.stringify(JSON.parse(XMLHttpRequest.responseText), null, 4);
            $("#result_text").text(result);
        }
    );

    return false;
}

function on_submit_1(obj){
    var name = $(obj)[0].name;
    var params = [];
    var arr = $(obj).find(".input");

    for(var i=0; i< arr.length; i++){
        console.log("name=", name, ",arr[i].name=", arr[i].name);
        if(arr[i].name == "boolean"){
            params[i] = arr[i].checked;
        }else{
            params[i] = arr[i].value;
        }
    }

    console.log("name=", name, ",params=", params);
    if(window.parent.remote()){
        return on_submit_remote(name, params);
    }

    console.log("name=", name, ",params=", params);
    window.parent.json_rpc(name, params, function (err, result) {
        if(err){
            $("#result_text").text(result);
            return;
        }
        console.log('err=', err, 'result=', result);

        result = JSON.parse(result);
        result = result.result;
        if(typeof(rpc_ret(name)) == 'object'){
            result = JSON.stringify(result, null, 4);
        }
        $("#result_text").text(result);
    })

    return false;
}

</script>

<style type="text/css">
	html
	{
	 height:100%;
	 margin:0;
	}
	body
	{
		height:99%;
		margin:0; 
	}
	
	hr{ border-top:1px solid #987cb9;}
	
	.left{ width:38%; float:left;border:1px solid green;height:100%;}
	.right{ width:60%; margin-left:38%;border:1px solid orange;height:100%;}

    table.funs {border:1px solid #666666}
    input[name="string"] {width:400px;}

    #result_text {
    width: 100%; /*自动适应父布局宽度*/  
	height: 100%;
    overflow: auto;  
    word-break: break-all;  
    /*在ie中解决断行问题(防止自动变为在一行显示，主要解决ie兼容问题，ie8中当设宽度为100%时，文本域类容超过一行时，当我们双击文本内容就会自动变为一行显示，所以只能用ie的专有断行属性“word-break或word-wrap”控制其断行)*/  
	}

    #trans {
        width: 100%; /*自动适应父布局宽度*/
        height: 30%;
        overflow: auto;
        word-break: break-all;
        /*在ie中解决断行问题(防止自动变为在一行显示，主要解决ie兼容问题，ie8中当设宽度为100%时，文本域类容超过一行时，当我们双击文本内容就会自动变为一行显示，所以只能用ie的专有断行属性“word-break或word-wrap”控制其断行)*/
    }
</style>

</head>

<body>
<div align="center">

<div class="w">
	<div class="left"><div align="left">
        <!--
                <form action="/web3/" class="fun.sync" method="get" name="eth.getBlock"  onsubmit="return on_trans(this);"> <table class="funs">
                    <textarea id="trans" width=400px height=400px> </textarea>
                    <input type="submit" name="submit" value="trans"/>
                </table></form>
        -->
                <form action="/web3/" class="fun.sync" method="get" name="eth.getBlock"  onsubmit="return on_submit(this);"> <table class="funs">

                    <input type="text" name="fname" size="66" value="0" /> <input type="submit" name="submit" value="getBlock"/> <hr class="division">
                </table></form>

                <form action="/web3/" class="" method="get" name="eth.blockNumber"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="submit" name="submit" value="blockNumber"/> <hr>
                </table></form>

                <form action="/web3/" class="fun" method="get" name="eth.getTransaction"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="text" name="fname" size="66"/> <input type="submit" name="submit" value="getTransaction"/> <hr>
                </table></form>

                <form action="/web3/" class="fun" method="get" name="eth.getTransactionFromBlock"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="text" name="fname" size="66" value="0" /> <input type="text" name="fname" value="0" /> <input type="submit" name="submit" value="getTransactionFromBlock"/> <hr>
                </table></form>

                <form action="/web3/" class="fun" method="get" name="eth.getTransactionReceipt"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="text" name="fname" size="66"/> <input type="submit" name="submit" value="getTransactionReceipt"/> <hr>
                </table></form>

                <form action="/web3/" class="fun" method="get" name="eth.getBalance"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="text" name="fname" size="44"/> <input type="submit" name="submit" value="getBalance"/> <hr>
                </table></form>

                <form action="/web3/" class="" method="get" name="personal.listAccounts"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="submit" name="submit" value="listAccounts"/>
                </table></form>

                <form action="/web3/" class="" method="get" name="eth.gasPrice"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="submit" name="submit" value="gasPrice"/>
                </table></form>

                <form action="/web3/" class="fun" method="get" name="eth.getCode"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="text" name="fname" size="66"/> <input type="submit" name="submit" value="getCode"/>
                </table></form>

                <form action="/web3/" class="fun" method="get" name="eth.getStorageAt"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="text" name="fname" size="66"/> <input type="text" name="fname" value="0"/> <input type="submit" name="submit" value="getStorageAt"/>
                </table></form>

                <form action="/web3/" class="" method="get" name="personal.listAccounts"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="submit" name="submit" value="listAccounts"/>
                </table></form>

                <form action="/web3/" class="" method="get" name="admin.peers"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="submit" name="submit" value="peers"/>
                </table></form>

                <form action="/web3/" class="fun" method="get" name="eth.getStorageAt"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="text" name="fname" size="66"/> <input type="text" name="fname" value="0"/> <input type="submit" name="submit" value="getStorageAt"/>
                </table></form>

                <form action="/web3/" class="fun" method="get" name="personal.newAccount"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="text" name="fname"/> <input type="submit" name="submit" value="newAccount"/>
                </table></form>

                <form action="/web3/" class="" method="get" name="version.api"  onsubmit="return on_submit(this);"> <table class="fun">
                    <input type="submit" name="submit" value="version"/>
                </table></form>
                <!--
                    <form action="/web3/" class="fun" method="get" name="getPeers"  onsubmit="return on_submit(this);"> <table class="fun">
                        <input type="submit" name="submit" value="getPeers"/>
                    </table></form>
                -->

        <div id="funs"></div>
<!--
	<form action="/web3/" class="fun" method="get" name="getPeers"  onsubmit="return on_submit(this);">
		<input type="submit" name="submit" value="getPeers"/>
    </form>
-->
    </div></div>
    <div class="right"><textarea id="result_text"></textarea></div>
    
</div>


</div>

<script type="text/javascript">
$(document).ready(function(){
	onDeviceReady();
});

</script>
</body>

</html>